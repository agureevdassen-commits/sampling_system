<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PWA —Å–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%231a1a2e' width='192' height='192'/><text x='96' y='120' font-size='80' font-weight='bold' fill='%2300d4ff' text-anchor='middle' font-family='Arial'>S</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #00d4ff;
            --primary-dark: #0099cc;
            --bg-light: #f5f5f5;
            --bg-dark: #1a1a2e;
            --text-light: #333;
            --text-dark: #fff;
            --border-light: #ddd;
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            line-height: 1.6;
            overflow: hidden;
        }

        body.dark-theme {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        #root {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        body.dark-theme .header {
            background: linear-gradient(135deg, #0a0a1a, var(--bg-dark));
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .header-title {
            font-size: 16px;
            font-weight: 700;
        }

        .sync-indicator {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sync-indicator.pending {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 0;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 12px;
            min-width: 0;
        }

        body.dark-theme .left-panel {
            background-color: var(--bg-dark);
        }

        .right-panel {
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease;
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            background: white;
        }

        body.dark-theme .right-panel {
            background-color: #0a0a1a;
            border-left-color: rgba(0, 212, 255, 0.2);
        }

        .right-panel.open {
            width: 100%;
            max-width: 400px;
        }

        @media (max-width: 768px) {
            .right-panel.open {
                width: 100%;
                max-width: 100%;
            }
        }

        /* –í–∏–¥–µ–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ï */
        .camera-section {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150px;
            height: 150px;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(0, 212, 255, 0.7);
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.3);
            pointer-events: none;
        }

        .camera-status {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 10;
        }

        .camera-status.initializing { color: #ff9800; }
        .camera-status.scanning { color: var(--success); animation: blink 0.6s infinite; }
        .camera-status.disabled { color: #999; }
        .camera-status.error { color: var(--error); }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
        .input-group {
            margin-bottom: 12px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        body.dark-theme .input-label {
            color: rgba(255, 255, 255, 0.8);
        }

        .input-wrapper {
            display: flex;
            gap: 6px;
        }

        input, select, textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background-color: #0f0f1a;
            border-color: rgba(0, 212, 255, 0.2);
            color: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 6px rgba(0, 212, 255, 0.3);
        }

        button {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--border-light);
            color: var(--text-light);
        }

        body.dark-theme .btn-secondary {
            background: #0f0f1a;
            color: var(--text-dark);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .btn-secondary:hover {
            background: #ccc;
        }

        body.dark-theme .btn-secondary:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 10px;
            min-width: 40px;
        }

        .ore-type-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .ore-type-btn {
            flex: 1;
            background: var(--border-light);
            color: var(--text-light);
            border: 2px solid transparent;
        }

        body.dark-theme .ore-type-btn {
            background: #0f0f1a;
            border-color: rgba(0, 212, 255, 0.2);
            color: var(--text-dark);
        }

        .ore-type-btn.active {
            background: var(--primary-color);
            color: var(--bg-dark);
            border-color: var(--primary-color);
        }

        /* –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ */
        .status-block {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
            min-height: 40px;
            display: flex;
            align-items: center;
            word-break: break-word;
            color: #666;
            background: #f0f0f0;
        }

        body.dark-theme .status-block {
            background: rgba(0, 212, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .status-block.success {
            background: rgba(76, 175, 80, 0.1);
            color: #2d5d1f;
            border-left: 4px solid var(--success);
        }

        body.dark-theme .status-block.success {
            background: rgba(76, 175, 80, 0.1);
            color: rgba(76, 175, 80, 0.9);
        }

        .status-block.error {
            background: rgba(244, 67, 54, 0.1);
            color: #6b1a1a;
            border-left: 4px solid var(--error);
        }

        body.dark-theme .status-block.error {
            background: rgba(244, 67, 54, 0.1);
            color: rgba(244, 67, 54, 0.9);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        body.dark-theme .stat-card {
            background: #0a0a1a;
            border-color: rgba(0, 212, 255, 0.2);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-theme .stat-label {
            color: rgba(255, 255, 255, 0.5);
        }

        /* –ü–∞–Ω–µ–ª—å —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–± */
        .scans-list-header {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
        }

        body.dark-theme .scans-list-header {
            border-bottom-color: rgba(0, 212, 255, 0.2);
        }

        .scans-search {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .scans-search input {
            flex: 1;
            min-width: 150px;
        }

        .scans-table {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .scan-row {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        body.dark-theme .scan-row {
            background: #0f0f1a;
            border-color: rgba(0, 212, 255, 0.2);
        }

        .scan-row:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .scan-row:hover {
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.2);
        }

        .scan-row-main {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scan-row-meta {
            font-size: 11px;
            color: #999;
        }

        body.dark-theme .scan-row-meta {
            color: rgba(255, 255, 255, 0.5);
        }

        .scan-row-server-id {
            color: var(--primary-color);
            font-size: 10px;
            margin-top: 4px;
        }

        .scans-list-footer {
            padding: 12px;
            border-top: 1px solid var(--border-light);
            text-align: center;
            font-size: 12px;
            color: #999;
        }

        body.dark-theme .scans-list-footer {
            border-top-color: rgba(0, 212, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
        }

        /* –ù–∏–∂–Ω–∏–π —Ç—É–ª–±–∞—Ä */
        .toolbar {
            display: flex;
            gap: 6px;
            padding: 12px;
            background: white;
            border-top: 1px solid var(--border-light);
            overflow-x: auto;
        }

        body.dark-theme .toolbar {
            background: #0a0a1a;
            border-top-color: rgba(0, 212, 255, 0.2);
        }

        .toolbar button {
            flex: 1;
            min-width: 80px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* –§—É—Ç–µ—Ä —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π */
        .footer-stats {
            display: none;
            background: white;
            border-top: 1px solid var(--border-light);
            padding: 12px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        body.dark-theme .footer-stats {
            background: #0a0a1a;
            border-top-color: rgba(0, 212, 255, 0.2);
        }

        .footer-stats.open {
            display: block;
        }

        .footer-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-theme .footer-stats-row {
            border-bottom-color: rgba(0, 212, 255, 0.2);
        }

        .footer-stats-row:last-child {
            border-bottom: none;
        }

        .footer-stats-label {
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-theme .footer-stats-label {
            color: rgba(255, 255, 255, 0.8);
        }

        .footer-stats-value {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .modal-content {
            background: var(--bg-dark);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-theme .modal-header {
            border-bottom-color: rgba(0, 212, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-size: 13px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .modal-footer {
            padding: 12px;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        body.dark-theme .modal-footer {
            border-top-color: rgba(0, 212, 255, 0.2);
        }

        /* –ß–µ–∫–±–æ–∫—Å */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: var(--bg-dark);
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
        }

        body.dark-theme .theme-toggle {
            background: #0f0f1a;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 600px) {
            .header-title {
                font-size: 14px;
            }

            .sync-indicator {
                font-size: 11px;
            }

            input, select {
                font-size: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                padding: 8px;
            }

            .toolbar button {
                font-size: 11px;
                padding: 8px;
            }

            .camera-section {
                aspect-ratio: 4 / 3;
            }
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 999;
            animation: slideUp 0.3s ease, slideDown 0.3s ease 2.7s;
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 20px); opacity: 0; }
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã - disabled —Å—Ç–∏–ª—å */
        .camera-disabled {
            opacity: 0.5;
        }

        .camera-status.disabled-text {
            background: rgba(100, 100, 100, 0.8);
            color: #ddd;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="header">
            <div class="header-title">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</div>
            <div class="sync-indicator" id="syncIndicator" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏">‚áÖ –ª–æ–∫–∞–ª—å–Ω–æ 0, –æ–∂–∏–¥–∞–Ω–∏–µ 0 / —Å–µ—Ä–≤–µ—Ä 0</div>
        </div>

        <div class="content">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
            <div class="left-panel">
                <div class="camera-section" id="cameraSection">
                    <video id="video" playsinline autoplay></video>
                    <div class="camera-overlay"></div>
                    <div class="camera-status" id="cameraStatus">üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>
                    <button class="btn-secondary btn-small" id="restartCameraBtn" style="position: absolute; bottom: 8px; left: 8px; z-index: 5;">‚ü≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
                </div>

                <div class="input-group">
                    <label class="input-label">–ü—Ä–æ–±–∞ (Sample)</label>
                    <div class="input-wrapper">
                        <input type="text" id="sampleInput" placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é" autocomplete="off">
                        <button class="btn-primary btn-icon" id="submitBtn" title="Enter">‚úì</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">–°–∫–≤–∞–∂–∏–Ω–∞ (Well)</label>
                    <input type="text" id="wellNameInput" placeholder="–ù–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä SW-001" autocomplete="off">
                </div>

                <div class="input-group">
                    <label class="input-label">–ë–ª–æ–∫ (Block)</label>
                    <input type="text" id="blockInput" placeholder="–ù–æ–º–µ—Ä –±–ª–æ–∫–∞" autocomplete="off">
                </div>

                <div class="input-group">
                    <label class="input-label">–¢–∏–ø —Ä—É–¥—ã (Ore Type)</label>
                    <div class="ore-type-buttons" id="oreTypeButtons"></div>
                    <select id="typeSelect" style="width: 100%;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                    </select>
                </div>

                <div class="status-block" id="statusBlock">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayCount">0</div>
                        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ</div>
                    </div>
                </div>

                <button class="btn-secondary" id="exportCsvBtn" style="width: 100%;">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –°–ø–∏—Å–æ–∫ –ø—Ä–æ–± -->
            <div class="right-panel" id="rightPanel">
                <div class="scans-list-header">üìã –ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –ø—Ä–æ–±—ã</div>
                
                <div style="padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ Sample –∏–ª–∏ —Å–∫–≤–∞–∂–∏–Ω–µ" autocomplete="off">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="pendingOnlyCheckbox">
                        <span style="font-size: 12px;">–¢–æ–ª—å–∫–æ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</span>
                    </label>
                </div>

                <div class="scans-table" id="scansTable"></div>
                <div class="scans-list-footer"><span id="scansCount">–ó–∞–ø–∏—Å–µ–π: 0</span></div>

                <div style="padding: 12px; border-top: 1px solid var(--border-light); display: flex; flex-direction: column; gap: 8px;">
                    <div>
                        <label class="input-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" id="operatorInput" placeholder="–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" autocomplete="off">
                    </div>
                    <div style="font-size: 12px;" id="connectionStatus">‚úÖ –û–Ω–ª–∞–π–Ω (–¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è)</div>
                </div>
            </div>
        </div>

        <div class="footer-stats" id="footerStats">
            <div class="footer-stats-row">
                <span class="footer-stats-label">–í—Å–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ:</span>
                <span class="footer-stats-value" id="statsLocalTotal">0</span>
            </div>
            <div class="footer-stats-row">
                <span class="footer-stats-label">–°–µ–≥–æ–¥–Ω—è:</span>
                <span class="footer-stats-value" id="statsToday">0</span>
            </div>
            <div class="footer-stats-row">
                <span class="footer-stats-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫:</span>
                <span class="footer-stats-value" id="statsLastBlock">‚Äî</span>
            </div>
            <div class="footer-stats-row">
                <span class="footer-stats-label" style="flex: 1;">–í–µ—Ä—Å–∏—è: 1.1.0 PWA - IndexedDB + SQL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω–∏–π —Ç—É–ª–±–∞—Ä -->
        <div class="toolbar">
            <button class="btn-secondary" id="toggleListBtn">üìã –ü—Ä–æ–±—ã</button>
            <button class="btn-secondary" id="toggleStatsBtn">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="btn-secondary" id="diagnosticsBtn">‚öô –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
    <div class="modal" id="diagnosticsModal">
        <div class="modal-content">
            <div class="modal-header">
                –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                <button class="btn-secondary btn-small" onclick="closeDiagnosticsModal()" style="padding: 4px 8px;">‚úï</button>
            </div>
            <div class="modal-body" id="diagnosticsLog"></div>
            <div class="modal-footer">
                <button class="btn-secondary" id="clearLogsBtn">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
                <button class="btn-primary" onclick="closeDiagnosticsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
    <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>

    <script src="https://unpkg.com/@zxing/library@latest/umd/index.js"></script>

    <script>
        // ======================== –ö–û–ù–°–¢–ê–ù–¢–´ ========================
        const API_URL = '/api';
        const API_KEY = 'sampling-dev-key-2025';
        const DB_NAME = 'sampling_scans_db_v2';
        const ORE_TYPES = ['520', '360'];
        const SYNC_INTERVAL = 30000;
        const CAMERA_FPS = 10; // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: 10-15 FPS –≤–º–µ—Å—Ç–æ 30+

        // ======================== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ========================
        let db = null;
        let codeReader = null;
        let isScanning = false;
        let isCameraActive = false;
        let lastScannedBarcode = null;
        let deviceId = null;
        let lastServerCount = 0;
        let isSyncing = false;
        let lastScanTime = 0;

        // ======================== DOM –≠–õ–ï–ú–ï–ù–¢–´ ========================
        const elements = {
            video: document.getElementById('video'),
            sampleInput: document.getElementById('sampleInput'),
            wellNameInput: document.getElementById('wellNameInput'),
            blockInput: document.getElementById('blockInput'),
            typeSelect: document.getElementById('typeSelect'),
            operatorInput: document.getElementById('operatorInput'),
            submitBtn: document.getElementById('submitBtn'),
            statusBlock: document.getElementById('statusBlock'),
            cameraStatus: document.getElementById('cameraStatus'),
            cameraSection: document.getElementById('cameraSection'),
            restartCameraBtn: document.getElementById('restartCameraBtn'),
            syncIndicator: document.getElementById('syncIndicator'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            toggleListBtn: document.getElementById('toggleListBtn'),
            toggleStatsBtn: document.getElementById('toggleStatsBtn'),
            diagnosticsBtn: document.getElementById('diagnosticsBtn'),
            rightPanel: document.getElementById('rightPanel'),
            footerStats: document.getElementById('footerStats'),
            scansTable: document.getElementById('scansTable'),
            scansCount: document.getElementById('scansCount'),
            searchInput: document.getElementById('searchInput'),
            pendingOnlyCheckbox: document.getElementById('pendingOnlyCheckbox'),
            todayCount: document.getElementById('todayCount'),
            totalCount: document.getElementById('totalCount'),
            connectionStatus: document.getElementById('connectionStatus'),
            diagnosticsModal: document.getElementById('diagnosticsModal'),
            diagnosticsLog: document.getElementById('diagnosticsLog'),
            clearLogsBtn: document.getElementById('clearLogsBtn'),
            themeToggle: document.getElementById('themeToggle'),
            oreTypeButtons: document.getElementById('oreTypeButtons')
        };

        // ======================== INDEXEDDB ========================
        class Database {
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);

                    request.onerror = () => {
                        addLog('error', `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: ${request.error}`);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        addLog('info', 'IndexedDB –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                        resolve();
                    };

                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;

                        if (!db.objectStoreNames.contains('scans')) {
                            const scansStore = db.createObjectStore('scans', { keyPath: 'id', autoIncrement: true });
                            scansStore.createIndex('sync_status', 'sync_status', { unique: false });
                            scansStore.createIndex('scanned_at', 'scanned_at', { unique: false });
                            scansStore.createIndex('sample', 'sample', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('logs')) {
                            db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            }

            async addScan(scan) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['scans'], 'readwrite');
                    const store = tx.objectStore('scans');
                    const request = store.add(scan);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllScans() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['scans'], 'readonly');
                    const store = tx.objectStore('scans');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getPendingScans() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['scans'], 'readonly');
                    const store = tx.objectStore('scans');
                    const index = store.index('sync_status');
                    const request = index.getAll('pending');

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async markSynced(localIds, serverIds) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['scans'], 'readwrite');
                    const store = tx.objectStore('scans');
                    const allScans = [];

                    const getAllRequest = store.getAll();
                    getAllRequest.onsuccess = () => {
                        const scans = getAllRequest.result;
                        scans.forEach((scan, idx) => {
                            if (localIds.includes(scan.id)) {
                                scan.sync_status = 'synced';
                                if (serverIds[idx] !== undefined) {
                                    scan.server_id = serverIds[idx];
                                }
                                store.put(scan);
                            }
                        });

                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject(tx.error);
                    };
                });
            }

            async addLog(entry) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['logs'], 'readwrite');
                    const store = tx.objectStore('logs');
                    const request = store.add(entry);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getLogs(limit = 100) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['logs'], 'readonly');
                    const store = tx.objectStore('logs');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const logs = request.result;
                        resolve(logs.slice(-limit));
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async clearLogs() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['logs'], 'readwrite');
                    const store = tx.objectStore('logs');
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ======================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ========================
        function addLog(level, message) {
            const entry = {
                ts: Date.now(),
                level,
                message
            };

            if (db && db.db) {
                db.addLog(entry).catch(e => console.error('Log error:', e));
            }

            console.log(`[${level.toUpperCase()}] ${message}`);
        }

        async function refreshDiagnosticsLog() {
            const logs = await db.getLogs(100);
            const logHtml = logs.map(log => {
                const date = new Date(log.ts);
                const timeStr = date.toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const levelClass = log.level === 'error' ? 'color: #f44336;' : '';
                return `<div style="${levelClass}">${timeStr} [${log.level.toUpperCase()}]: ${escapeHtml(log.message)}</div>`;
            }).join('');
            elements.diagnosticsLog.innerHTML = logHtml || '(–Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π)';
        }

        function closeDiagnosticsModal() {
            elements.diagnosticsModal.classList.remove('open');
        }

        // ======================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û) ========================
        function isSampleInputEmpty() {
            return !elements.sampleInput.value.trim();
        }

        async function initCamera() {
            if (!isSampleInputEmpty()) {
                stopCamera();
                return;
            }

            if (isCameraActive) return;

            try {
                elements.cameraStatus.textContent = 'üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶';
                elements.cameraStatus.className = 'camera-status initializing';

                codeReader = new ZXing.BrowserMultiFormatReader();
                const devices = await codeReader.listVideoInputDevices();

                let selectedDevice = null;
                const backCamera = devices.find(d => d.label.toLowerCase().includes('back'));
                selectedDevice = backCamera || devices[devices.length - 1];

                if (!selectedDevice) {
                    throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                isScanning = true;
                isCameraActive = true;
                lastScanTime = 0;

                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–∏–∑–∫–∏–º FPS
                const decodeInterval = 1000 / CAMERA_FPS; // ~100–º—Å –¥–ª—è 10 FPS

                codeReader.decodeFromVideoDevice(selectedDevice.deviceId, 'video', (result, err) => {
                    const now = Date.now();
                    
                    // Throttle: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫–∞–∂–¥—ã–µ N –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
                    if (now - lastScanTime < decodeInterval) {
                        return;
                    }

                    if (result && result.text !== lastScannedBarcode) {
                        lastScanTime = now;
                        lastScannedBarcode = result.text;
                        onBarcodeScan(result.text);
                    }
                });

                elements.cameraStatus.textContent = 'üü¢ –°–∫–∞–Ω–∏—Ä—É–µ—Ç';
                elements.cameraStatus.className = 'camera-status scanning';
                elements.cameraSection.classList.remove('camera-disabled');
                addLog('info', `–ö–∞–º–µ—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (${CAMERA_FPS} FPS)`);
            } catch (error) {
                elements.cameraStatus.textContent = 'üî¥ –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã';
                elements.cameraStatus.className = 'camera-status error';
                isCameraActive = false;
                addLog('error', `–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${error.message}`);
            }
        }

        function stopCamera() {
            if (codeReader && isScanning) {
                try {
                    codeReader.reset();
                    isScanning = false;
                    isCameraActive = false;
                    elements.cameraStatus.textContent = '‚≠ï –û—Ç–∫–ª—é—á–µ–Ω–∞';
                    elements.cameraStatus.className = 'camera-status disabled-text';
                    elements.cameraSection.classList.add('camera-disabled');
                    addLog('info', '–ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞');
                } catch (e) {
                    console.error('Error stopping camera:', e);
                }
            }
        }

        function restartCamera() {
            stopCamera();
            setTimeout(initCamera, 500);
        }

        function onBarcodeScan(barcode) {
            elements.sampleInput.value = barcode;
            elements.sampleInput.focus();
            stopCamera(); // –û—Ç–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
            addLog('info', `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${barcode}`);
            showNotification(`üìå –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${barcode}`);
        }

        // ======================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ========================
        async function init() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
                db = new Database();
                await db.init();
                addLog('info', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–∑ localStorage
                loadConfig();

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Ä—É–¥—ã
                initOreTypes();

                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(() => addLog('info', 'Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
                        .catch(e => addLog('error', `Service Worker –æ—à–∏–±–∫–∞: ${e.message}`));
                }

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Device ID
                if (!localStorage.getItem('deviceId')) {
                    deviceId = 'device-' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('deviceId', deviceId);
                } else {
                    deviceId = localStorage.getItem('deviceId');
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                attachEventHandlers();

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
                initCamera();

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                refreshStats();
                refreshScans();

                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                syncPendingScans();
                setInterval(syncPendingScans, SYNC_INTERVAL);

                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                window.addEventListener('online', () => {
                    addLog('info', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    updateConnectionStatus();
                    syncPendingScans();
                });

                window.addEventListener('offline', () => {
                    addLog('info', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
                    updateConnectionStatus();
                });

                updateConnectionStatus();
            } catch (error) {
                addLog('error', `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
            }
        }

        function loadConfig() {
            const savedBlock = localStorage.getItem('lastBlock');
            const savedOperator = localStorage.getItem('operatorName');

            if (savedBlock) elements.blockInput.value = savedBlock;
            if (savedOperator) elements.operatorInput.value = savedOperator;
        }

        function initOreTypes() {
            ORE_TYPES.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                elements.typeSelect.appendChild(option);

                const btn = document.createElement('button');
                btn.className = 'btn-secondary ore-type-btn';
                btn.textContent = type;
                btn.onclick = (e) => {
                    e.preventDefault();
                    elements.typeSelect.value = type;
                    document.querySelectorAll('.ore-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                elements.oreTypeButtons.appendChild(btn);
            });
        }

        function attachEventHandlers() {
            elements.submitBtn.addEventListener('click', processScan);
            
            // –û—Ç–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ Sample
            elements.sampleInput.addEventListener('input', (e) => {
                if (e.target.value.trim().length > 0) {
                    stopCamera();
                } else {
                    initCamera();
                }
            });

            // –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —á–µ—Ä–µ–∑ Backspace
            elements.sampleInput.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value.trim()) {
                    setTimeout(() => {
                        if (!elements.sampleInput.value.trim()) {
                            initCamera();
                        }
                    }, 0);
                }
            });

            elements.sampleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') processScan();
            });

            elements.exportCsvBtn.addEventListener('click', exportCSV);
            elements.restartCameraBtn.addEventListener('click', restartCamera);
            elements.toggleListBtn.addEventListener('click', () => {
                elements.rightPanel.classList.toggle('open');
            });
            elements.toggleStatsBtn.addEventListener('click', () => {
                elements.footerStats.classList.toggle('open');
            });
            elements.diagnosticsBtn.addEventListener('click', () => {
                elements.diagnosticsModal.classList.add('open');
                refreshDiagnosticsLog();
            });
            elements.syncIndicator.addEventListener('click', syncPendingScans);
            elements.searchInput.addEventListener('input', refreshScans);
            elements.pendingOnlyCheckbox.addEventListener('change', refreshScans);
            elements.blockInput.addEventListener('change', () => {
                localStorage.setItem('lastBlock', elements.blockInput.value);
            });
            elements.operatorInput.addEventListener('change', () => {
                localStorage.setItem('operatorName', elements.operatorInput.value);
            });
            elements.clearLogsBtn.addEventListener('click', async () => {
                await db.clearLogs();
                refreshDiagnosticsLog();
                addLog('info', '–ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω');
            });
            elements.themeToggle.addEventListener('click', toggleTheme);
        }

        // ======================== –û–ë–†–ê–ë–û–¢–ö–ê –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø ========================
        function saveScanToDb(scan) {
            if (!scan.sample || !scan.sample.trim()) {
                showStatusMessage('–í–≤–µ–¥–∏—Ç–µ Sample –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', 'error');
                elements.sampleInput.focus();
                return false;
            }

            if (!scan.block || !scan.block.trim()) {
                showStatusMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–ë–ª–æ–∫"', 'error');
                elements.blockInput.focus();
                return false;
            }

            if (!scan.well_name || !scan.well_name.trim()) {
                showStatusMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–°–∫–≤–∞–∂–∏–Ω–∞"', 'error');
                elements.wellNameInput.focus();
                return false;
            }

            db.addScan(scan)
                .then(() => {
                    addLog('info', `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${scan.sample} (–±–ª–æ–∫ ${scan.block})`);
                    return true;
                })
                .catch(err => {
                    addLog('error', `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message}`);
                    showStatusMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    return false;
                });

            return true;
        }

        function processScan() {
            const sample = elements.sampleInput.value.trim();
            const wellName = elements.wellNameInput.value.trim();
            const block = elements.blockInput.value.trim();
            const type = elements.typeSelect.value;

            if (!sample) {
                showStatusMessage('–í–≤–µ–¥–∏—Ç–µ Sample –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', 'error');
                elements.sampleInput.focus();
                return;
            }

            if (!block) {
                showStatusMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–ë–ª–æ–∫"', 'error');
                elements.blockInput.focus();
                return;
            }

            if (!wellName) {
                showStatusMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–°–∫–≤–∞–∂–∏–Ω–∞"', 'error');
                elements.wellNameInput.focus();
                return;
            }

            const scan = {
                sample,
                well_name: wellName,
                block,
                type: type || '',
                scanned_at: Date.now(),
                scanned_by: elements.operatorInput.value || 'unknown',
                sync_status: 'pending',
                is_test: false
            };

            if (saveScanToDb(scan)) {
                // –£—Å–ø–µ—Ö
                playBeep();
                vibrate();

                showStatusMessage(`‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ: ${sample} (—Å–∫–≤–∞–∂–∏–Ω–∞ ${wellName}, –±–ª–æ–∫ ${block})`, 'success');

                elements.sampleInput.value = '';
                lastScannedBarcode = null;
                refreshStats();
                refreshScans();

                syncPendingScans();

                setTimeout(() => {
                    elements.sampleInput.focus();
                    // –ù–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É - –±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–æ–ª—è
                }, 500);
            }
        }

        // ======================== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ========================
        async function syncPendingScans() {
            if (isSyncing || !navigator.onLine) return;

            isSyncing = true;

            try {
                const pending = await db.getPendingScans();

                if (pending.length === 0) {
                    updateSyncIndicator();
                    isSyncing = false;
                    return;
                }

                const payload = pending.map(scan => ({
                    device_id: deviceId,
                    sample: scan.sample,
                    well_name: scan.well_name,
                    block: scan.block,
                    type: scan.type,
                    scanned_at: scan.scanned_at,
                    scanned_by: scan.scanned_by,
                    is_test: scan.is_test || false,
                    local_id: scan.id
                }));

                const response = await fetch(`${API_URL}/scans/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                const serverIds = result.server_ids || [];
                lastServerCount = result.total_on_server || 0;

                await db.markSynced(
                    pending.map(s => s.id),
                    serverIds
                );

                addLog('info', `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${pending.length} –ø—Ä–æ–±`);
                refreshStats();
                refreshScans();
                updateSyncIndicator();
            } catch (error) {
                addLog('error', `–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`);
            } finally {
                isSyncing = false;
            }
        }

        // ======================== UI –û–ë–ù–û–í–õ–ï–ù–ò–ï ========================
        async function refreshStats() {
            const allScans = await db.getAllScans();
            const pending = await db.getPendingScans();

            const today = new Date().toDateString();
            const todayScans = allScans.filter(s => new Date(s.scanned_at).toDateString() === today);

            elements.todayCount.textContent = todayScans.length;
            elements.totalCount.textContent = allScans.length;

            elements.statsLocalTotal.textContent = allScans.length;
            elements.statsToday.textContent = todayScans.length;

            const lastBlock = allScans.length > 0 ? allScans[allScans.length - 1].block : '‚Äî';
            elements.statsLastBlock.textContent = lastBlock;

            updateSyncIndicator();
        }

        async function updateSyncIndicator() {
            const allScans = await db.getAllScans();
            const pending = await db.getPendingScans();

            const text = `‚áÖ –ª–æ–∫–∞–ª—å–Ω–æ ${allScans.length}, –æ–∂–∏–¥–∞–Ω–∏–µ ${pending.length} / —Å–µ—Ä–≤–µ—Ä ${lastServerCount}`;
            elements.syncIndicator.textContent = text;

            if (pending.length > 0) {
                elements.syncIndicator.classList.add('pending');
            } else {
                elements.syncIndicator.classList.remove('pending');
            }
        }

        async function refreshScans() {
            const allScans = await db.getAllScans();
            const searchTerm = elements.searchInput.value.toLowerCase();
            const showPendingOnly = elements.pendingOnlyCheckbox.checked;

            let filtered = allScans.filter(scan => {
                const matchesSearch = !searchTerm || 
                    scan.sample.toLowerCase().includes(searchTerm) ||
                    scan.well_name.toLowerCase().includes(searchTerm);
                const matchesStatus = !showPendingOnly || scan.sync_status === 'pending';
                return matchesSearch && matchesStatus;
            });

            filtered.sort((a, b) => b.scanned_at - a.scanned_at);

            elements.scansTable.innerHTML = filtered.map(scan => {
                const date = new Date(scan.scanned_at).toLocaleString('ru-RU');
                const syncBadge = scan.sync_status === 'pending' ? '‚è≥' : '‚úÖ';
                return `
                    <div class="scan-row">
                        <div class="scan-row-main">${escapeHtml(scan.sample)} ${syncBadge}</div>
                        <div class="scan-row-meta">—Å–∫–≤–∞–∂–∏–Ω–∞: ${escapeHtml(scan.well_name)}</div>
                        <div class="scan-row-meta">—Ç–∏–ø/–±–ª–æ–∫: ${escapeHtml(scan.type || '‚Äî')} / ${escapeHtml(scan.block)}</div>
                        <div class="scan-row-meta">${date}</div>
                        ${scan.server_id ? `<div class="scan-row-server-id">ID –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${scan.server_id}</div>` : ''}
                    </div>
                `;
            }).join('');

            elements.scansCount.textContent = `–ó–∞–ø–∏—Å–µ–π: ${filtered.length}`;
        }

        function updateConnectionStatus() {
            const status = navigator.onLine 
                ? '‚úÖ –û–Ω–ª–∞–π–Ω (–¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è)'
                : 'üî¥ –û—Ñ–ª–∞–π–Ω (–∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)';
            elements.connectionStatus.textContent = status;
        }

        // ======================== –≠–ö–°–ü–û–†–¢ ========================
        async function exportCSV() {
            const allScans = await db.getAllScans();

            let csv = 'Sample,–°–∫–≤–∞–∂–∏–Ω–∞,–¢–∏–ø,–ë–ª–æ–∫,–î–∞—Ç–∞,–°–æ—Ç—Ä—É–¥–Ω–∏–∫,SyncStatus,ServerID\n';
            allScans.forEach(scan => {
                const date = new Date(scan.scanned_at).toLocaleString('ru-RU');
                csv += `"${scan.sample}","${scan.well_name}","${scan.type}","${scan.block}","${date}","${scan.scanned_by}","${scan.sync_status}","${scan.server_id || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `scans_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            addLog('info', `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${allScans.length} –ø—Ä–æ–± –≤ CSV`);
            showNotification('üì• CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');

            restartCamera();
        }

        // ======================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ========================
        function showStatusMessage(message, type = 'info') {
            elements.statusBlock.textContent = message;
            elements.statusBlock.className = `status-block ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.frequency.value = 800;
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

                osc.start(now);
                osc.stop(now + 0.1);
            } catch (e) {
                console.log('Beep –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        }

        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 50]);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            elements.themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Ç–µ–º—ã
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
            elements.themeToggle.textContent = '‚òÄÔ∏è';
        }

        // ======================== –ó–ê–ü–£–°–ö ========================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
